<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Digital Lab Chatbot</title>
<style>
  body{background:#0b0b0b;color:#fff;font-family:Inter,Arial;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:100%;max-width:420px;height:95vh;background:#111;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden}
  .header{padding:14px;background:linear-gradient(90deg,#7c4dff,#4dd0e1);font-weight:600;text-align:center}
  .chat{flex:1;padding:12px;overflow:auto}
  .msg{margin:8px 0;padding:10px;border-radius:12px;max-width:80%;word-break:break-word}
  .me{background:#00e5a8;color:#000;margin-left:auto;border-bottom-right-radius:2px}
  .bot{background:#1f1f1f;border:1px solid #222;color:#ddd}
  .controls{padding:10px;background:#0f0f0f;display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px}
  input[type=text]{flex:1;padding:10px;border-radius:20px;border:1px solid #222;background:#080808;color:#fff}
  button{background:#7c4dff;color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
  small{color:#999}
</style>
</head>
<body>
  <div class="card">
    <div class="header">💡 Digital Lab Chatbot — Student Support</div>
    <div id="chat" class="chat"></div>

    <div class="controls">
      <div class="row">
        <input id="input" type="text" placeholder="Type your question...">
        <button onclick="send()">Send</button>
      </div>

      <div class="row">
        <input id="image" type="file" accept="image/*">
        <button onclick="uploadImage()">📷 Image</button>
        <button onclick="uploadFile()">📁 PDF</button>
      </div>

      <div class="row">
        <button onclick="startVoice()">🎙️ Speak</button>
        <button onclick="downloadTranscript()">📥 Transcript</button>
        <button onclick="generateQuiz()">📝 Quiz</button>
      </div>

      <div><small>Tip: Try asking "Make me a 30-day plan for Dropshipping Mastery"</small></div>
    </div>
  </div>

<script>
async function send(){
  const val = document.getElementById("input").value.trim();
  if(!val) return;
  addMsg(val,'me');
  document.getElementById("input").value = '';
  const res = await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:val})});
  const j = await res.json();
  addMsg(j.reply,'bot');
  speakText(j.reply);
}

function addMsg(text,cls){
  const c = document.getElementById('chat');
  const d = document.createElement('div');
  d.className = 'msg ' + cls;
  d.innerText = text;
  c.appendChild(d);
  c.scrollTop = c.scrollHeight;
}

async function uploadImage(){
  const f = document.getElementById('image').files[0];
  if(!f) return alert('Select an image');
  addMsg('📷 Image uploaded...','me');
  const fd = new FormData(); fd.append('image', f);
  const res = await fetch('/upload-image',{method:'POST',body:fd});
  const j = await res.json();
  addMsg(j.reply,'bot'); speakText(j.reply);
}

async function uploadFile(){
  const input = document.createElement('input');
  input.type='file'; input.accept='.pdf';
  input.onchange = async ()=> {
    const f = input.files[0];
    if(!f) return;
    const fd = new FormData(); fd.append('file', f);
    addMsg('📁 File uploaded','me');
    const res = await fetch('/upload-file',{method:'POST',body:fd});
    const j = await res.json();
    addMsg(j.reply,'bot'); speakText(j.reply);
  };
  input.click();
}

function speakText(text){
  if('speechSynthesis' in window){
    const s = new SpeechSynthesisUtterance(text);
    s.lang = 'en-US';
    window.speechSynthesis.speak(s);
  }
}

function startVoice(){
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
    alert('Voice not supported in this browser. Use Chrome.');
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SpeechRecognition();
  rec.lang = 'en-US';
  rec.onresult = e => {
    const text = e.results[0][0].transcript;
    document.getElementById('input').value = text;
    send();
  };
  rec.start();
}

async function downloadTranscript(){
  const res = await fetch('/download-transcript');
  if(res.status === 200){
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'transcript.txt'; a.click();
  } else { alert('Transcript download failed'); }
}

async function generateQuiz(){
  const topic = prompt('Enter topic for quiz (e.g., Module 2: Product Research)');
  if(!topic) return;
  addMsg('📝 Generating quiz...','me');
  const res = await fetch('/quiz',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic,length:5})});
  const j = await res.json();
  addMsg(j.quiz,'bot'); speakText('Here is your quiz.');
}
</script>
</body>
</html>
